import React, { useState, useEffect } from 'react';

const TyskLaering = () => {
  const [currentExercise, setCurrentExercise] = useState(0);
  const [userAnswer, setUserAnswer] = useState('');
  const [feedback, setFeedback] = useState('');
  const [score, setScore] = useState(0);
  const [showConjugation, setShowConjugation] = useState(false);
  const [showInstructions, setShowInstructions] = useState(false);
  const [voices, setVoices] = useState([]);
  const [germanVoices, setGermanVoices] = useState([]);
  const [germanVoice, setGermanVoice] = useState(null);
  const [speechRate, setSpeechRate] = useState(0.8); // Default speech rate (slightly faster than before)

  // Sein conjugation data
  const seinConjugation = [
    { pronoun: 'ich', verb: 'bin', translation: 'jeg er' },
    { pronoun: 'du', verb: 'bist', translation: 'du er' },
    { pronoun: 'er/sie/es', verb: 'ist', translation: 'han/hun/det er' },
    { pronoun: 'wir', verb: 'sind', translation: 'vi er' },
    { pronoun: 'ihr', verb: 'seid', translation: 'I er' },
    { pronoun: 'sie/Sie', verb: 'sind', translation: 'de/De er' }
  ];

  // Exercise data
  const exercises = [
    {
      question: 'Hvilket ord mangler? Ich ___ ein Sch√ºler.',
      correctAnswer: 'bin',
      hint: 'F√∏rste person ental',
      translation: 'Jeg er en elev.'
    },
    {
      question: 'Hvilket ord mangler? Du ___ meine Freundin.',
      correctAnswer: 'bist',
      hint: 'Anden person ental',
      translation: 'Du er min veninde.'
    },
    {
      question: 'Hvilket ord mangler? Er ___ aus Deutschland.',
      correctAnswer: 'ist',
      hint: 'Tredje person ental (han)',
      translation: 'Han er fra Tyskland.'
    },
    {
      question: 'Hvilket ord mangler? Sie ___ aus der Schweiz.',
      correctAnswer: 'ist',
      hint: 'Tredje person ental (hun)',
      translation: 'Hun er fra Schweiz.'
    },
    {
      question: 'Hvilket ord mangler? Es ___ ein Buch.',
      correctAnswer: 'ist',
      hint: 'Tredje person ental (intetk√∏n)',
      translation: 'Det er en bog.'
    },
    {
      question: 'Hvilket ord mangler? Wir ___ in der Schule.',
      correctAnswer: 'sind',
      hint: 'F√∏rste person flertal',
      translation: 'Vi er i skolen.'
    },
    {
      question: 'Hvilket ord mangler? Ihr ___ sehr nett.',
      correctAnswer: 'seid',
      hint: 'Anden person flertal',
      translation: 'I er meget s√∏de.'
    },
    {
      question: 'Hvilket ord mangler? Sie ___ meine Lehrer.',
      correctAnswer: 'sind',
      hint: 'Tredje person flertal',
      translation: 'De er mine l√¶rere.'
    }
  ];

  // Load available voices and find German ones
  useEffect(() => {
    const loadVoices = () => {
      const availableVoices = window.speechSynthesis.getVoices();
      setVoices(availableVoices);
      
      // Try to find German voices
      const germVoices = availableVoices.filter(voice => 
        voice.lang.includes('de') || voice.name.includes('Deutsch') || voice.name.includes('German')
      );
      
      setGermanVoices(germVoices);
      
      if (germVoices.length > 0) {
        setGermanVoice(germVoices[0]); // Default to first German voice
      } else if (availableVoices.length > 0) {
        // Fallback to any available voice
        setGermanVoice(availableVoices[0]);
      }
    };

    // Safari sometimes requires a small delay
    if (window.speechSynthesis) {
      if (window.speechSynthesis.getVoices().length > 0) {
        loadVoices();
      } else {
        window.speechSynthesis.onvoiceschanged = loadVoices;
      }
    }
    
    // Ensure speech cancellation when component unmounts
    return () => {
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    };
  }, []);

  // Speak text function
  const speakText = (text) => {
    if (!window.speechSynthesis) {
      alert('Din browser underst√∏tter ikke opl√¶sning. Pr√∏v venligst med Safari p√• iOS.');
      return;
    }

    // Cancel any ongoing speech
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    if (germanVoice) {
      utterance.voice = germanVoice;
      utterance.lang = 'de-DE';
    }
    utterance.rate = speechRate; // Use the selected speech rate
    utterance.pitch = 1;
    
    // Add a slight pause between words for better clarity
    const words = text.split(' ');
    if (words.length > 1) {
      text = words.join(' . ');
    }
    
    utterance.text = text;
    window.speechSynthesis.speak(utterance);
  };

  // Handle answer submission
  const handleSubmit = () => {
    const currentEx = exercises[currentExercise];
    
    if (userAnswer.trim().toLowerCase() === currentEx.correctAnswer.toLowerCase()) {
      setFeedback('Korrekt! üéâ');
      setScore(score + 1);
      
      // Move to next exercise or finish
      setTimeout(() => {
        if (currentExercise < exercises.length - 1) {
          setCurrentExercise(currentExercise + 1);
          setUserAnswer('');
          setFeedback('');
        } else {
          setFeedback(`Godt klaret! Du fik ${score + 1} ud af ${exercises.length} rigtige!`);
        }
      }, 1500);
    } else {
      setFeedback(`Forkert. Pr√∏v igen eller brug et hint.`);
    }
  };

  // Get hint
  const getHint = () => {
    setFeedback(`Hint: ${exercises[currentExercise].hint}`);
  };

  // Speak full sentence
  const speakFullSentence = () => {
    const ex = exercises[currentExercise];
    const fullSentence = ex.question.replace('___', ex.correctAnswer);
    // Remove the question part "Hvilket ord mangler? "
    const cleanSentence = fullSentence.replace('Hvilket ord mangler? ', '');
    speakText(cleanSentence);
  };

  // Speak translation in Danish
  const speakTranslation = () => {
    if (!window.speechSynthesis) {
      alert('Din browser underst√∏tter ikke opl√¶sning. Pr√∏v venligst med Safari p√• iOS.');
      return;
    }

    // Cancel any ongoing speech
    window.speechSynthesis.cancel();

    const translation = exercises[currentExercise].translation;
    const utterance = new SpeechSynthesisUtterance(translation);
    
    // Find a Danish voice if available
    const danishVoice = voices.find(voice => 
      voice.lang.includes('da-') || voice.name.includes('Danish') || voice.name.includes('Dansk')
    );
    
    if (danishVoice) {
      utterance.voice = danishVoice;
    }
    
    utterance.lang = 'da-DK';
    utterance.rate = speechRate;
    utterance.pitch = 1;
    
    window.speechSynthesis.speak(utterance);
  };

  // Reset the exercise
  const resetExercise = () => {
    setCurrentExercise(0);
    setUserAnswer('');
    setFeedback('');
    setScore(0);
  };

  return (
    <div className="p-2 max-w-md mx-auto bg-blue-50 rounded-lg shadow-md" style={{minHeight: '100vh'}}>
      <h1 className="text-xl font-bold text-center my-3 text-blue-800">L√¶r det tyske verbum "sein" (at v√¶re)</h1>
      
      {/* Conjugation Table - On iPhone, will be tappable to expand */}
      <div className="mb-4">
        <button 
          onClick={() => setShowConjugation(!showConjugation)}
          className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition text-sm font-medium"
        >
          {showConjugation ? 'Skjul b√∏jning' : 'Vis b√∏jning af "sein"'}
        </button>
        
        {showConjugation && (
          <div className="mt-2 bg-white p-2 rounded-md shadow-sm overflow-x-auto">
            <h3 className="text-base font-semibold mb-2 text-center">B√∏jning af "sein" (at v√¶re)</h3>
            <div className="overflow-x-auto -mx-2 px-2">
              <table className="w-full border-collapse text-sm">
                <thead>
                  <tr className="bg-blue-100">
                    <th className="border border-blue-200 p-1">Pronomen</th>
                    <th className="border border-blue-200 p-1">Sein</th>
                    <th className="border border-blue-200 p-1">Dansk</th>
                    <th className="border border-blue-200 p-1">Lyt</th>
                  </tr>
                </thead>
                <tbody>
                  {seinConjugation.map((item, index) => (
                    <tr key={index} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                      <td className="border border-blue-200 p-1">{item.pronoun}</td>
                      <td className="border border-blue-200 p-1 font-medium">{item.verb}</td>
                      <td className="border border-blue-200 p-1">{item.translation}</td>
                      <td className="border border-blue-200 p-1 text-center">
                        <button
                          onClick={() => speakText(`${item.pronoun} ${item.verb}`)}
                          className="text-blue-600 hover:text-blue-800 text-lg px-2"
                          aria-label="Lyt til udtale"
                        >
                          üîä
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {/* Exercise Section */}
      {currentExercise < exercises.length && (
        <div className="bg-white p-3 rounded-lg shadow-sm">
          <h2 className="text-lg font-semibold mb-3">√òvelse {currentExercise + 1} af {exercises.length}</h2>
          
          <p className="mb-3 text-base">{exercises[currentExercise].question}</p>
          
          <div className="flex gap-1 mb-3">
            <button onClick={speakFullSentence} className="flex-1 bg-green-600 text-white px-2 py-2 rounded text-sm hover:bg-green-700">
              üîä H√∏r s√¶tning
            </button>
            <button onClick={speakTranslation} className="flex-1 bg-purple-600 text-white px-2 py-2 rounded text-sm hover:bg-purple-700">
              üîä H√∏r overs√¶ttelse
            </button>
          </div>
          
          <div className="mb-3">
            <input
              type="text"
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              placeholder="Skriv dit svar her..."
              className="w-full p-3 border border-gray-300 rounded text-base"
              onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
              style={{fontSize: '16px'}} // Prevents iOS zoom on input focus
            />
          </div>
          
          <div className="flex gap-1">
            <button
              onClick={handleSubmit}
              className="flex-1 bg-blue-600 text-white py-3 rounded hover:bg-blue-700 text-base"
            >
              Tjek svar
            </button>
            <button
              onClick={getHint}
              className="flex-1 bg-yellow-500 text-white py-3 rounded hover:bg-yellow-600 text-base"
            >
              Hint
            </button>
          </div>
          
          {feedback && (
            <div className={`mt-3 p-3 rounded ${feedback.includes('Korrekt') || feedback.includes('Godt klaret') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
              {feedback}
            </div>
          )}
        </div>
      )}
      
      {/* Score Display - Only show at the end */}
      {currentExercise >= exercises.length && (
        <div className="bg-white p-4 rounded-lg shadow-sm text-center">
          <h2 className="text-xl font-bold mb-3">√òvelsen er f√¶rdig!</h2>
          <p className="text-lg mb-3">Din score: {score} ud af {exercises.length}</p>
          <button
            onClick={resetExercise}
            className="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-base"
          >
            Start forfra
          </button>
        </div>
      )}
      
      {/* Voice Controls - Simplified for iPhone */}
      <div className="mt-4 bg-white p-3 rounded-lg shadow-sm">
        <h3 className="font-bold mb-1 text-sm">Stemmeindstillinger:</h3>
        
        <div className="mb-3">
          <label className="block text-xs font-medium mb-1">V√¶lg tysk stemme:</label>
          <select 
            className="w-full p-2 border border-gray-300 rounded text-sm"
            style={{fontSize: '16px'}} // Prevents iOS zoom on select focus
            value={germanVoice ? germanVoice.name : ''}
            onChange={(e) => {
              const selectedVoice = voices.find(v => v.name === e.target.value);
              if (selectedVoice) {
                setGermanVoice(selectedVoice);
              }
            }}
          >
            <option value="" disabled>V√¶lg en stemme</option>
            {germanVoices.length > 0 ? (
              germanVoices.map(voice => (
                <option key={voice.name} value={voice.name}>
                  {voice.name}
                </option>
              ))
            ) : (
              <option value="" disabled>Ingen tyske stemmer fundet</option>
            )}
            {voices.map(voice => (
              !germanVoices.includes(voice) && (
                <option key={voice.name} value={voice.name}>
                  {voice.name}
                </option>
              )
            ))}
          </select>
        </div>
        
        <div>
          <label className="block text-xs font-medium mb-1">
            Talehastighed: {speechRate.toFixed(1)}
          </label>
          <input 
            type="range" 
            min="0.5" 
            max="1.0" 
            step="0.1"
            value={speechRate}
            onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
            className="w-full"
          />
          <div className="flex justify-between text-xs text-gray-500">
            <span>Langsom</span>
            <span>Normal</span>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-1 mt-2">
          <button 
            onClick={() => speakText("Hallo, ich bin deine deutsche Stimme. Guten Tag!")}
            className="bg-green-600 text-white px-2 py-2 rounded-md hover:bg-green-700 w-full text-sm"
          >
            Test tysk stemme
          </button>
          <button 
            onClick={() => {
              const utterance = new SpeechSynthesisUtterance("Hej, dette er en test af den danske overs√¶ttelse");
              utterance.lang = "da-DK";
              utterance.rate = speechRate;
              window.speechSynthesis.speak(utterance);
            }}
            className="bg-blue-600 text-white px-2 py-2 rounded-md hover:bg-blue-700 w-full text-sm"
          >
            Test dansk stemme
          </button>
        </div>
      </div>
      
      {/* Instructions - Collapsed by default on iPhone */}
      <div className="mt-4 mb-10">
        <button 
          onClick={() => setShowInstructions(!showInstructions)} 
          className="w-full bg-gray-200 text-gray-800 py-2 rounded-md hover:bg-gray-300 transition text-sm mb-1"
        >
          {showInstructions ? 'Skjul vejledning' : 'Vis vejledning'}
        </button>
        
        {showInstructions && (
          <div className="bg-blue-100 p-3 rounded text-xs">
            <h3 className="font-bold mb-1">S√•dan bruger du programmet:</h3>
            <ul className="list-disc pl-4 space-y-1">
              <li>Udfyld det manglende ord i s√¶tningen (b√∏jninger af "sein")</li>
              <li>Klik p√• lydikonet for at h√∏re s√¶tningen eller overs√¶ttelsen</li>
              <li>Brug "Hint" hvis du har brug for hj√¶lp</li>
              <li>Tryk "Tjek svar" eller Enter for at kontrollere dit svar</li>
              <li>Juster stemmens hastighed med skyderen, hvis den taler for hurtigt</li>
            </ul>
          </div>
        )}
      </div>
    </div>
  );
};

export default TyskLaering;